{% extends "base.html" %}

{% block title %}Записи - Bonus Education CRM{% endblock %}

{% block page_title %}
    <i class="fas fa-calendar-check me-3" style="color: var(--primary-color);"></i>
    Записи на курсы
{% endblock %}

{% block page_subtitle %}Управление записями студентов на курсы{% endblock %}

{% block content %}
<!-- Поиск и фильтры -->
<div class="card mb-4 fade-in-up">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text" style="background: var(--primary-gradient); color: white; border: none;">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Поиск записей..." style="border: 2px solid rgba(102,126,234,0.1); border-left: none;">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary filter-btn active" data-status="all">
                        <i class="fas fa-list me-2"></i>Все
                    </button>
                    <button class="btn btn-outline-warning filter-btn" data-status="new">
                        <i class="fas fa-hourglass-half me-2"></i>Ожидают
                    </button>
                    <button class="btn btn-outline-success filter-btn" data-status="success">
                        <i class="fas fa-check-circle me-2"></i>Подтверждены
                    </button>
                    <button class="btn btn-outline-danger filter-btn" data-status="failed">
                        <i class="fas fa-times-circle me-2"></i>Отменены
                    </button>
                    <a href="/kanban" class="btn btn-primary">
                        <i class="fas fa-columns me-2"></i>Kanban доска
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Таблица записей -->
<div class="card fade-in-up" style="animation-delay: 0.1s;">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-calendar-check me-3"></i>
            Список записей
        </h5>
    </div>
    <div class="card-body p-0">
        {% if bookings %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th><i class="fas fa-user me-2"></i>Пользователь</th>
                        <th><i class="fas fa-book me-2"></i>Курс</th>
                        <th><i class="fas fa-chalkboard-teacher me-2"></i>Преподаватель</th>
                        <th><i class="fas fa-calendar me-2"></i>Дата записи</th>
                        <th><i class="fas fa-info-circle me-2"></i>Статус</th>
                        <th><i class="fas fa-cogs me-2"></i>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr class="booking-row fade-in-up" data-status="{{ booking.get('status', 'new') }}" style="animation-delay: {{ loop.index0 * 0.05 }}s;">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="activity-icon me-3">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div>
                                    <div class="fw-bold" style="color: var(--dark-color);">{{ booking.get('user_name', 'Не указано') }}</div>
                                    <small class="text-muted">
                                        <i class="fas fa-phone me-1"></i>
                                        {{ booking.get('user_phone', 'Не указан') }}
                                    </small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-primary">
                                <i class="fas fa-book-open me-1"></i>
                                {{ booking.get('course_name', 'Не указано') }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-tie me-2 text-muted"></i>
                                <span>{{ booking.get('teacher_name', 'Не назначен') }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-muted"></i>
                                <span>{{ booking.get('created_at_fmt', '—') }}</span>
                            </div>
                        </td>
                        <td>
                            {% if booking.get('status') == 'success' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>
                                    Подтверждена
                                </span>
                            {% elif booking.get('status') == 'new' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-hourglass-half me-1"></i>
                                    Ожидает
                                </span>
                            {% elif booking.get('status') == 'failed' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times me-1"></i>
                                    Отменена
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-question me-1"></i>
                                    {{ booking.get('status', 'new') }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                {% if booking.get('status') == 'new' %}
                                <button class="btn btn-success btn-sm" onclick="confirmBooking({{ booking.get('id', 0) }})" title="Подтвердить">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="cancelBooking({{ booking.get('id', 0) }})" title="Отменить">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                                <a class="btn btn-outline-primary btn-sm" href="/bookings/{{ booking.get('id', 0) }}" title="Просмотр">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteBooking({{ booking.get('id', 0) }}, '{{ booking.get('user_name', 'Запись')|escape }}')" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h5>Пока нет записей</h5>
            <p>Когда студенты запишутся на курсы, они появятся здесь</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Поиск записей
    document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const bookingRows = document.querySelectorAll('.booking-row');
        
        bookingRows.forEach(row => {
            const userName = row.querySelector('td:first-child').textContent.toLowerCase();
            const courseName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            
            if (userName.includes(searchTerm) || courseName.includes(searchTerm)) {
                row.style.display = '';
                row.style.animation = 'fadeInUp 0.3s ease-out';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Фильтрация по статусу
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.add('btn-outline-primary', 'btn-outline-warning', 'btn-outline-success', 'btn-outline-danger');
            });
            
            this.classList.add('active');
            this.classList.remove('btn-outline-primary', 'btn-outline-warning', 'btn-outline-success', 'btn-outline-danger');
            
            const status = this.dataset.status;
            const bookingRows = document.querySelectorAll('.booking-row');
            
            bookingRows.forEach(row => {
                const rowStatus = row.dataset.status;
                
                if (status === 'all' || rowStatus === status) {
                    row.style.display = '';
                    row.style.animation = 'fadeInUp 0.3s ease-out';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // Функции управления записями
    function confirmBooking(bookingId) {
        if (confirm('Подтвердить запись?')) {
            fetch(`/update_booking_status/${bookingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'status=success'
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Запись подтверждена!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Ошибка при подтверждении записи', 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка при подтверждении записи', 'error');
            });
        }
    }

    function cancelBooking(bookingId) {
        if (confirm('Отменить запись?')) {
            fetch(`/update_booking_status/${bookingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'status=failed'
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Запись отменена!', 'warning');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Ошибка при отмене записи', 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка при отмене записи', 'error');
            });
        }
    }

    function viewBooking(bookingId) {}

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger'} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: var(--border-radius);';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Анимация появления строк таблицы
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('.booking-row');
        rows.forEach((row, index) => {
            row.style.opacity = '0';
            row.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                row.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                row.style.opacity = '1';
                row.style.transform = 'translateX(0)';
            }, index * 50);
        });
    });

    function deleteBooking(bookingId, userName) {
        if (confirm(`Удалить запись пользователя "${userName}"? Это действие нельзя отменить.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_booking/${bookingId}`;
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}