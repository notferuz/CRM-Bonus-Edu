{% extends "base.html" %}

{% block title %}Kanban доска - CRM система{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок страницы -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-columns me-2"></i>
                Kanban доска
            </h1>
            <p class="text-muted mb-0">Управление заявками через визуальную доску</p>
        </div>
        <div>
            <a href="/bookings" class="btn btn-outline-info">
                <i class="fas fa-table me-2"></i>Табличный вид
            </a>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Всего заявок
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-bookings">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Успешные
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="success-bookings">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-trophy fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                В процессе
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="process-bookings">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Не получилось
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="failed-bookings">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kanban доска -->
<div class="kanban-board" id="kanbanBoard">
    <!-- Колонка: Все заявки Baza -->
    <div class="kanban-column" data-status="all">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-database"></i>
                Все заявки Baza
            </div>
            <div class="column-count" id="count-all">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'all' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'all') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Новая заявка -->
    <div class="kanban-column" data-status="new">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-plus-circle"></i>
                Новая заявка
            </div>
            <div class="column-count" id="count-new">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'new' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'new') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Дозвон -->
    <div class="kanban-column" data-status="call_success">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-phone-volume"></i>
                Дозвон
            </div>
            <div class="column-count" id="count-call_success">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'call_success' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'call_success') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Не дозвон -->
    <div class="kanban-column" data-status="call_failed">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-phone-slash"></i>
                Не дозвон
            </div>
            <div class="column-count" id="count-call_failed">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'call_failed' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'call_failed') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Перезвонить -->
    <div class="kanban-column" data-status="callback">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-redo"></i>
                Перезвонить
            </div>
            <div class="column-count" id="count-callback">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'callback' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'callback') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Запись на пробный -->
    <div class="kanban-column" data-status="trial_booking">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-calendar-plus"></i>
                Запись на пробный
            </div>
            <div class="column-count" id="count-trial_booking">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'trial_booking' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'trial_booking') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Запись на онлайн пробный -->
    <div class="kanban-column" data-status="online_trial_booking">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-video"></i>
                Запись на онлайн пробный
            </div>
            <div class="column-count" id="count-online_trial_booking">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'online_trial_booking' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'online_trial_booking') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Провели пробный -->
    <div class="kanban-column" data-status="trial_completed">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-check-circle"></i>
                Провели пробный
            </div>
            <div class="column-count" id="count-trial_completed">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'trial_completed' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'trial_completed') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Предоплата -->
    <div class="kanban-column" data-status="prepayment">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-credit-card"></i>
                Предоплата
            </div>
            <div class="column-count" id="count-prepayment">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'prepayment' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'prepayment') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: В ожидании гр -->
    <div class="kanban-column" data-status="waiting_group">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-users"></i>
                В ожидании гр
            </div>
            <div class="column-count" id="count-waiting_group">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'waiting_group' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'waiting_group') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Успешно реализована -->
    <div class="kanban-column" data-status="success">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-trophy"></i>
                Успешно реализована
            </div>
            <div class="column-count" id="count-success">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'success' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'success') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Колонка: Не получилось -->
    <div class="kanban-column" data-status="failed">
        <div class="column-header">
            <div class="column-title">
                <i class="fas fa-times-circle"></i>
                Не получилось
            </div>
            <div class="column-count" id="count-failed">0</div>
        </div>
        <div class="column-content" ondrop="drop(event)" ondragover="allowDrop(event)">
            {% for booking in bookings %}
                {% if booking.get('status') == 'failed' %}
                <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-booking-id="{{ booking.get('id') }}" data-status="{{ booking.get('status', 'failed') }}">
                    <div class="card-header">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h6 class="user-name">{{ booking.get('user_name', 'Не указано') }}</h6>
                                <div class="user-phone">{{ booking.get('user_phone', 'Не указан') }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBooking({{ booking.get('id') }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="course-info">
                            <span class="badge bg-primary">
                                <i class="fas fa-book me-1"></i>
                                {{ booking.get('course_name', 'Курс не указан') }}
                            </span>
                        </div>
                        <div class="booking-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ booking.get('created_at', '')[:16] if booking.get('created_at') else 'Не указано' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .kanban-board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding: 20px 0;
        min-height: 600px;
    }

    .kanban-column {
        min-width: 300px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .kanban-column:hover {
        box-shadow: 0 4px 16px rgba(85,128,241,0.1);
    }

    .column-header {
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #5580f1;
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .column-title {
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        color: white;
    }

    .column-title i {
        margin-right: 8px;
        font-size: 1rem;
    }

    .column-count {
        background: rgba(255,255,255,0.2);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.8rem;
        min-width: 24px;
        text-align: center;
    }

    .column-content {
        padding: 20px;
        min-height: 500px;
        transition: var(--transition);
    }

    .column-content.drag-over {
        background: rgba(11,111,253,0.05);
        border: 2px dashed #0b6ffd;
        border-radius: 20px;
    }

    .kanban-card {
        background: #ffffff;
        border-radius: 20px;
        margin-bottom: 12px;
        border: 2px solid #0b6ffd;
        transition: all 0.2s ease;
        cursor: grab;
        position: relative;
        overflow: visible;
    }

    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(11,111,253,0.15);
        border-color: #0b6ffd;
    }

    .kanban-card:active {
        cursor: grabbing;
        transform: scale(1.02);
    }

    .kanban-card.dragging {
        opacity: 0.7;
        transform: rotate(2deg);
        box-shadow: 0 8px 24px rgba(11,111,253,0.25);
        z-index: 1000;
    }

    .card-header {
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #5680f1;
        border-radius: 20px 20px 0 0 !important;
        margin: 0;
        position: relative;
        z-index: 1;
        overflow: hidden;
    }

    .card-header:first-child {
        border-radius: 20px 20px 0 0 !important;
    }

    .user-info {
        display: flex;
        align-items: center;
        flex: 1;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255,255,255,0.2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1rem;
        font-weight: 600;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        margin: 0 0 2px 0;
        font-weight: 600;
        color: white;
        font-size: 0.95rem;
        line-height: 1.3;
    }

    .user-phone {
        color: rgba(255,255,255,0.8);
        font-size: 0.8rem;
        font-weight: 500;
    }

    .card-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .kanban-card:hover .card-actions {
        opacity: 1;
    }

    .card-actions .btn {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.1);
        color: white;
        transition: all 0.2s ease;
    }

    .card-actions .btn:hover {
        background: rgba(255,255,255,0.2);
        color: white;
        border-color: rgba(255,255,255,0.5);
    }

    .card-body {
        padding: 16px;
        overflow: visible;
    }

    .course-info {
        margin-bottom: 8px;
    }

    .course-info .badge {
        background: #5580f1;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.85rem;
        display: block;
        width: 100%;
        word-wrap: break-word;
        line-height: 1.3;
        white-space: normal;
        text-align: left;
    }

    .booking-time {
        color: #374151;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Единый стиль для всех карточек */
    .kanban-card {
        border: 2px solid #0b6ffd;
    }

    /* Минималистичные анимации */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .kanban-card {
        animation: slideIn 0.2s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .kanban-board {
            flex-direction: column;
            gap: 15px;
        }
        
        .kanban-column {
            min-width: 100%;
        }
    }
</style>

<script>
    let draggedElement = null;

    // Drag and Drop функции
    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    function drag(ev) {
        draggedElement = ev.target;
        ev.target.classList.add('dragging');
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData('text/html', ev.target.outerHTML);
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');
        
        if (draggedElement) {
            const newStatus = ev.currentTarget.closest('.kanban-column').dataset.status;
            const bookingId = draggedElement.dataset.bookingId;
            
            // Обновляем статус на сервере
            updateBookingStatus(bookingId, newStatus);
            
            // Перемещаем элемент в новую колонку
            ev.currentTarget.appendChild(draggedElement);
            draggedElement.classList.remove('dragging');
            
            // Обновляем счетчики
            updateCounters();
            
            // Показываем уведомление
            showNotification('Статус обновлен', 'success');
        }
        
        draggedElement = null;
    }

    // Убираем drag-over класс при уходе мыши
    document.addEventListener('dragleave', function(e) {
        if (e.target.classList.contains('column-content')) {
            e.target.classList.remove('drag-over');
        }
    });

    // Обновление счетчиков
    function updateCounters() {
        const statuses = ['all', 'new', 'call_success', 'call_failed', 'callback', 'trial_booking', 'online_trial_booking', 'trial_completed', 'prepayment', 'waiting_group', 'success', 'failed'];
        
        statuses.forEach(status => {
            const count = document.querySelectorAll(`[data-status="${status}"] .kanban-card`).length;
            const countElement = document.getElementById(`count-${status}`);
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }

    // Обновление статуса на сервере
    async function updateBookingStatus(bookingId, status) {
        try {
            const formData = new FormData();
            formData.append('status', status);
            
            const response = await fetch(`/update_booking_status/${bookingId}`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!result.success) {
                showNotification('Ошибка обновления статуса', 'error');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка соединения', 'error');
        }
    }

    function viewBooking(bookingId) {
        // Просмотр детальной информации о записи
        showNotification('Просмотр записи (функция в разработке)', 'info');
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
        notification.style.cssText = `
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            min-width: 200px; 
            border-radius: 4px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: none;
            padding: 12px 16px;
            font-weight: 500;
            font-size: 0.9rem;
        `;
        
        notification.innerHTML = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 2000);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        updateCounters();
        
        // Обновляем общую статистику
        const totalBookings = document.querySelectorAll('.kanban-card').length;
        const successBookings = document.querySelectorAll('[data-status="success"] .kanban-card').length;
        const processBookings = document.querySelectorAll('[data-status="new"], [data-status="call_success"], [data-status="callback"], [data-status="trial_booking"], [data-status="online_trial_booking"], [data-status="trial_completed"], [data-status="prepayment"], [data-status="waiting_group"] .kanban-card').length;
        const failedBookings = document.querySelectorAll('[data-status="failed"] .kanban-card').length;
        
        document.getElementById('total-bookings').textContent = totalBookings;
        document.getElementById('success-bookings').textContent = successBookings;
        document.getElementById('process-bookings').textContent = processBookings;
        document.getElementById('failed-bookings').textContent = failedBookings;
    });
</script>
{% endblock %}
